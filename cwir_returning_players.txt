create or replace view dataanalytics.bi.wwe2k22_cwir_returning_players as

WITH TITLES_CTE AS
(
    SELECT 
        *
   
    FROM (values
            ('WWE 2K22', DATE('2022-03-08'), 'Current')
            /*"The game name as in Standard Metrics", "The games release date", "How you'd like to refer to the game"*/ 
         ) as TITLE_TABLES (TITLE, RELEASE_DATE, TITLE_IDENTIFIER)
),
 
DATES_CTE AS
(
    SELECT
        DATE
   
    FROM "DATAANALYTICS"."REFERENCE"."DIM_DATE"
     
    WHERE DATE < CURRENT_DATE() -- REMOVE = FOR LAUNCH
        AND DATE >= (SELECT MIN(RELEASE_DATE) FROM TITLES_CTE)
)
 
/*PLATFORMS AND TITLES*/
,PLATFORMS_AND_SERVICES_CTE AS (
    SELECT DISTINCT
        DIM_TITLE.TITLE,
        TITLES_CTE.RELEASE_DATE,
        DATEDIFF('day',CURR.RELEASE_DATE, CURRENT_DATE()-1 ) MAX_DAYS, -- CHANGE - 1 AT LAUNCH
        TITLES_CTE.TITLE_IDENTIFIER,     
        DIM_TITLE.DISPLAY_PLATFORM AS PLATFORM,
        DIM_TITLE.DISPLAY_SERVICE AS SERVICE       
     
    FROM (SELECT DISTINCT TITLE, DISPLAY_PLATFORM, DISPLAY_SERVICE FROM REFERENCE.TITLE.DIM_TITLE) DIM_TITLE
        INNER JOIN TITLES_CTE
            ON DIM_TITLE.TITLE = TITLES_CTE.TITLE
        CROSS JOIN (Select RELEASE_DATE from TITLES_CTE
             where TITLE_IDENTIFIER = 'Current' group by 1 ) curr
),
 
COUNTRIES_CTE AS
(
    SELECT
        COUNTRY_CODE,
        NAME AS COUNTRY_NAME,
        IFNULL(TERRITORY_CODE, 'ZZ') AS TERRITORY_CODE,
        IFNULL(TERRITORY_NAME, 'Unknown') AS TERRITORY_NAME,
        IFNULL(REGION_CODE, 'ZZ') AS REGION_CODE,
        IFNULL(REGION_NAME, 'Unknown') AS REGION_NAME
         
    FROM DATAANALYTICS.REFERENCE.DIM_COUNTRY
),
RETURNING_PLAYERS_CTE AS 
(
    SELECT
      PLAYER_ID_WWE2K22 AS PLAYER_ID,
      MAX(CASE WHEN TITLE = 'WWE 2K20' THEN 1 ELSE 0 END) AS PREVIOUSLY_INSTALLED_2K20,
      MAX(CASE WHEN TITLE = 'WWE 2K19' THEN 1 ELSE 0 END) AS PREVIOUSLY_INSTALLED_2K19
    
    FROM WWE2K22.EVENTS.VW_WWE2K22_RETURNING_PLAYERS
    GROUP BY PLAYER_ID
)

SELECT 
DIM_WEEK.WEEK_ENDING WEEK,
    INSTALLS_SUB.TITLE,
    PLATFORM,
    SERVICE,
    country.COUNTRY_CODE,
    RELEASE_DATE,
    CURRENT_RELEASE_DATE,
    max_days,
    LAST_DATE,
    SUM(INSTALLS) AS INSTALLS,
    SUM(RETURNING_TO_FRANCHISE) AS RETURNING_TO_FRANCHISE,
    SUM(PREVIOUSLY_PLAYED_WWE2K20_AND_19) AS PREVIOUSLY_PLAYED_WWE2K20_AND_19,
    SUM(PREVIOUSLY_PLAYED_ONLY_2K20) AS PREVIOUSLY_PLAYED_ONLY_2K20,
    SUM(PREVIOUSLY_PLAYED_ONLY_2K19) AS PREVIOUSLY_PLAYED_ONLY_2K19,
    ifnull(country.name, 'Unknown') AS country_name,
ifnull(country.territory_name, 'Unknown') AS territory_name,
ifnull(country.region_name, 'Unknown') AS region_name
FROM
    (
        SELECT
          INSTALL_DATE,
          FACT_PLAYERS_LTD.TITLE,
          PLATFORM,
          SERVICE,
          COUNTRY_CODE,
          TITLES_CTE.RELEASE_DATE,
          MAX_DAY.RELEASE_DATE CURRENT_RELEASE_DATE,
          datediff('day',max(MAX_DAY.RELEASE_DATE),first_value(INSTALL_DATE ignore nulls) over (partition by 'Overall' order by INSTALL_DATE DESC)) as max_days,
          first_value(INSTALL_DATE ignore nulls) over (partition by SERVICE order by INSTALL_DATE DESC) as LAST_DATE,
          COUNT(*) AS INSTALLS,
          COUNT(CASE WHEN RETURNING_PLAYERS_CTE.PLAYER_ID IS NOT NULL THEN FACT_PLAYERS_LTD.PLAYER_ID END) AS RETURNING_TO_FRANCHISE,
          COUNT(CASE WHEN RETURNING_PLAYERS_CTE.PREVIOUSLY_INSTALLED_2K20 = 1 AND RETURNING_PLAYERS_CTE.PREVIOUSLY_INSTALLED_2K19 = 1 THEN FACT_PLAYERS_LTD.PLAYER_ID END) AS PREVIOUSLY_PLAYED_WWE2K20_AND_19,
          COUNT(CASE WHEN RETURNING_PLAYERS_CTE.PREVIOUSLY_INSTALLED_2K20 = 1 AND RETURNING_PLAYERS_CTE.PREVIOUSLY_INSTALLED_2K19 = 0 THEN FACT_PLAYERS_LTD.PLAYER_ID END) AS PREVIOUSLY_PLAYED_ONLY_2K20,
          COUNT(CASE WHEN RETURNING_PLAYERS_CTE.PREVIOUSLY_INSTALLED_2K20 = 0 AND RETURNING_PLAYERS_CTE.PREVIOUSLY_INSTALLED_2K19 = 1 THEN FACT_PLAYERS_LTD.PLAYER_ID END) AS PREVIOUSLY_PLAYED_ONLY_2K19
        FROM DATAANALYTICS.STANDARD_METRICS.FACT_PLAYERS_LTD
          INNER JOIN TITLES_CTE
            ON FACT_PLAYERS_LTD.TITLE = TITLES_CTE.TITLE 
          INNER JOIN TITLES_CTE MAX_DAY
            ON MAX_DAY.TITLE_IDENTIFIER = 'Current'
          LEFT JOIN RETURNING_PLAYERS_CTE
            ON FACT_PLAYERS_LTD.PLAYER_ID = RETURNING_PLAYERS_CTE.PLAYER_ID
              AND MAX_DAY.TITLE_IDENTIFIER = 'Current'
        WHERE INSTALL_DATE < CURRENT_DATE()
        GROUP BY 1, 2, 3, 4, 5, 6, 7
    ) INSTALLS_SUB
    
         INNER JOIN DATAANALYTICS.BI.WWE2K22_CWIR_DIM_WEEK DIM_WEEK
            ON INSTALLS_SUB.INSTALL_DATE >= DIM_WEEK.WEEK_STARTING
                AND INSTALLS_SUB.INSTALL_DATE <= DIM_WEEK.WEEK_ENDING
                
         LEFT JOIN dataanalytics.reference.dim_country country
 ON country.country_code = INSTALLS_SUB.COUNTRY_CODE  
  
  GROUP BY 1, 2, 3, 4, 5, 6, 7, 8, 9,15,16,17